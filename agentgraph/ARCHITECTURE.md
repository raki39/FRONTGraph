# üèóÔ∏è AgentGraph - Arquitetura T√©cnica Detalhada

## üéØ Vis√£o Geral

O AgentGraph √© uma **plataforma multi-agente** constru√≠da com LangGraph, implementando uma arquitetura modular e extens√≠vel baseada em n√≥s especializados. O sistema suporta m√∫ltiplos provedores LLM (OpenAI, Anthropic, HuggingFace) com processamento ass√≠ncrono, gerenciamento inteligente de objetos n√£o-serializ√°veis e sistema robusto de retry para rate limiting.

### **Principais Inova√ß√µes Arquiteturais**
- üîÑ **Fluxo Otimizado**: Detec√ß√£o ‚Üí AgentSQL ‚Üí Refinamento (sem LLM intermedi√°ria)
- üß† **Multi-Provedor**: Suporte nativo a OpenAI, Anthropic e HuggingFace
- üõ†Ô∏è **Tool-Calling**: Ferramentas SQL nativas with verbose ativo
- üéõÔ∏è **Object Manager**: Solu√ß√£o elegante para objetos n√£o-serializ√°veis
- ‚ö° **Async/Await**: Processamento n√£o-bloqueante em toda a stack
- üîç **LangSmith Integration**: Observabilidade completa com rastreamento autom√°tico

## üìÅ Estrutura do Projeto

```
agentgraph/
‚îú‚îÄ‚îÄ app.py                     # Entry point: Gradio + LangGraph
‚îú‚îÄ‚îÄ graphs/
‚îÇ   ‚îî‚îÄ‚îÄ main_graph.py          # StateGraph principal
‚îú‚îÄ‚îÄ nodes/                     # N√≥s especializados
‚îÇ   ‚îú‚îÄ‚îÄ csv_processing_node.py # Processamento gen√©rico de CSV
‚îÇ   ‚îú‚îÄ‚îÄ database_node.py       # Opera√ß√µes de banco de dados
‚îÇ   ‚îú‚îÄ‚îÄ query_node.py          # Processamento de consultas
‚îÇ   ‚îú‚îÄ‚îÄ refinement_node.py     # Refinamento de respostas
‚îÇ   ‚îú‚îÄ‚îÄ cache_node.py          # Gerenciamento de cache
‚îÇ   ‚îú‚îÄ‚îÄ agent_node.py          # Coordena√ß√£o geral
‚îÇ   ‚îî‚îÄ‚îÄ custom_nodes.py        # N√≥s especializados
‚îú‚îÄ‚îÄ agents/
‚îÇ   ‚îú‚îÄ‚îÄ sql_agent.py           # Cria√ß√£o do agente SQL
‚îÇ   ‚îî‚îÄ‚îÄ tools.py               # Ferramentas do agente
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ database.py            # Fun√ß√µes de banco de dados
‚îÇ   ‚îú‚îÄ‚îÄ config.py              # Configura√ß√µes
‚îÇ   ‚îî‚îÄ‚îÄ object_manager.py      # Gerenciador de objetos n√£o-serializ√°veis
‚îú‚îÄ‚îÄ uploaded_data/             # Arquivos CSV enviados
‚îú‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ ARCHITECTURE.md
‚îî‚îÄ‚îÄ .env
```

## üîÑ Fluxo do LangGraph

### Fluxo Principal de Consulta

```mermaid
graph TD
    A[validate_input] --> B[check_cache]
    B --> C{Cache Hit?}
    C -->|Sim| H[update_history]
    C -->|N√£o| D[prepare_context]
    D --> E[get_db_sample]
    E --> F[process_query]
    F --> G{Modo Avan√ßado?}
    G -->|Sim| I[refine_response]
    G -->|N√£o| J[cache_response]
    I --> K[format_response]
    K --> J
    J --> H
    H --> L[END]
```

### N√≥s Especializados

#### 1. **csv_processing_node.py**
- **Fun√ß√£o**: Processamento gen√©rico de CSV
- **Caracter√≠sticas**:
  - Detec√ß√£o autom√°tica de separadores (`;`, `,`, `\t`, `|`)
  - Identifica√ß√£o inteligente de tipos de dados
  - Convers√£o robusta para SQL types
  - Estat√≠sticas de processamento

#### 2. **database_node.py**
- **Fun√ß√£o**: Opera√ß√µes de banco de dados
- **Caracter√≠sticas**:
  - Cria√ß√£o de banco a partir de DataFrame processado
  - Carregamento de banco existente
  - Obten√ß√£o de amostras de dados
  - Valida√ß√£o de integridade

#### 3. **query_node.py**
- **Fun√ß√£o**: Processamento de consultas SQL
- **Caracter√≠sticas**:
  - Valida√ß√£o de entrada
  - Prepara√ß√£o de contexto
  - Execu√ß√£o via agente SQL
  - Tratamento de erros

#### 4. **refinement_node.py**
- **Fun√ß√£o**: Refinamento de respostas
- **Caracter√≠sticas**:
  - Modo avan√ßado com LLM adicional
  - Avalia√ß√£o de qualidade
  - Formata√ß√£o final
  - Adi√ß√£o de insights

#### 5. **cache_node.py**
- **Fun√ß√£o**: Gerenciamento de cache e hist√≥rico
- **Caracter√≠sticas**:
  - Verifica√ß√£o de cache
  - Armazenamento de respostas
  - Atualiza√ß√£o de hist√≥rico
  - Estat√≠sticas de uso

## üîç Integra√ß√£o LangSmith

### **Observabilidade Autom√°tica**
O AgentGraph inclui integra√ß√£o completa com LangSmith para rastreamento e monitoramento:

```python
# Configura√ß√£o autom√°tica via vari√°veis de ambiente
LANGSMITH_TRACING=true
LANGSMITH_API_KEY=lsv2_pt_...
LANGSMITH_PROJECT=agentgraph-project

# Rastreamento autom√°tico de todo o fluxo LangGraph
workflow.invoke(state) # ‚Üê Automaticamente rastreado
```

### **Componentes Rastreados**
- ‚úÖ **Todos os n√≥s LangGraph**: validate_input ‚Üí process_query ‚Üí cache_response
- ‚úÖ **Agentes SQL**: Chamadas LLM com inputs/outputs completos
- ‚úÖ **Modelos Multi-Provedor**: OpenAI, Anthropic, HuggingFace
- ‚úÖ **Opera√ß√µes de Dados**: CSV processing, database operations
- ‚úÖ **Gera√ß√£o de Gr√°ficos**: Sele√ß√£o e cria√ß√£o de visualiza√ß√µes

### **Benef√≠cios da Integra√ß√£o**
- üîç **Debug Avan√ßado**: Visualize fluxo completo de execu√ß√£o
- üìä **M√©tricas de Performance**: Lat√™ncia por n√≥ e opera√ß√£o
- üí∞ **An√°lise de Custos**: Uso de tokens por modelo
- üêõ **Troubleshooting**: Identifique gargalos e erros
- üìà **Dashboards**: Monitoramento em tempo real

## üß† Gerenciador de Objetos

### Problema Resolvido
O LangGraph requer que o estado seja serializ√°vel, mas objetos como SQLAgentManager, Engine e CacheManager n√£o s√£o serializ√°veis.

### Solu√ß√£o: ObjectManager
```python
# Armazena objetos n√£o-serializ√°veis
agent_id = object_manager.store_sql_agent(sql_agent)
engine_id = object_manager.store_engine(engine)
cache_id = object_manager.store_cache_manager(cache_manager)

# Estado serializ√°vel
state = {
    "user_input": "query",
    "agent_id": agent_id,
    "engine_id": engine_id,
    "cache_id": cache_id
}

# Recupera objetos quando necess√°rio
sql_agent = object_manager.get_sql_agent(agent_id)
```

## üìä Processamento CSV Gen√©rico

### Detec√ß√£o Autom√°tica de Tipos

```python
# Detecta automaticamente:
- Datas: Tenta convers√£o com pd.to_datetime()
- N√∫meros inteiros: Verifica padr√µes num√©ricos
- N√∫meros decimais: Detecta pontos/v√≠rgulas
- Texto: Mant√©m como string

# Regras de processamento:
- parse_dates: Para colunas de data
- convert_to_int: Para n√∫meros inteiros
- convert_to_float: Para n√∫meros decimais
- convert_text_to_int/float: Para texto num√©rico
- keep_as_text: Para texto puro
```

### Separadores Suportados
- `;` (ponto e v√≠rgula)
- `,` (v√≠rgula)
- `\t` (tab)
- `|` (pipe)

## üîß Configura√ß√µes

### Arquivo .env
```env
# API Keys
HUGGINGFACE_API_KEY=your_key_here
OPENAI_API_KEY=your_key_here
ANTHROPIC_API_KEY=your_key_here

# LangSmith - Observabilidade (OPCIONAL)
LANGSMITH_API_KEY=lsv2_pt_your_key_here
LANGSMITH_TRACING=true
LANGSMITH_ENDPOINT=https://api.smith.langchain.com
LANGSMITH_PROJECT=agentgraph-project

# Database Configuration
SQL_DB_PATH=data.db
DEFAULT_CSV_PATH=tabela.csv
UPLOAD_DIR=uploaded_data

# Model Configuration
DEFAULT_MODEL=GPT-4o-mini
MAX_ITERATIONS=40
TEMPERATURE=0

# Gradio Configuration
GRADIO_SHARE=False
GRADIO_PORT=7860
```

## üöÄ Funcionalidades

### ‚úÖ Mantidas do C√≥digo Original
- M√∫ltiplos modelos LLM (LLaMA 70B, 8B, Qwen 32B)
- Upload de CSV personalizado
- Sistema de cache inteligente
- Modo avan√ßado com refinamento
- Hist√≥rico de conversas
- Interface Gradio moderna
- Reset do sistema

### ‚úÖ Novas Funcionalidades
- Processamento gen√©rico de CSV
- Arquitetura modular de n√≥s
- Gerenciamento de objetos n√£o-serializ√°veis
- Fluxo condicional otimizado
- Valida√ß√£o autom√°tica de sistema
- Detec√ß√£o autom√°tica de portas
- Logs estruturados
- **Integra√ß√£o LangSmith**: Observabilidade completa e autom√°tica

## üß™ Testes

### Arquivo de Teste
```bash
python test_new_architecture.py
```

Testa individualmente:
- Processamento CSV
- Cria√ß√£o de banco
- Agente SQL
- Gerenciador de objetos
- Amostra de dados

## üîÑ Deploy

### Local
```bash
python app.py
```

### HuggingFace Spaces
1. Configure as vari√°veis de ambiente
2. Fa√ßa upload dos arquivos
3. O sistema detectar√° automaticamente a porta dispon√≠vel

## üìà Benef√≠cios da Nova Arquitetura

1. **Escalabilidade**: F√°cil adi√ß√£o de novos n√≥s
2. **Manutenibilidade**: C√≥digo organizado e modular
3. **Robustez**: Sem problemas de serializa√ß√£o
4. **Flexibilidade**: Processamento gen√©rico de dados
5. **Performance**: Fluxo otimizado com cache
6. **Debugging**: Logs detalhados por n√≥
7. **Testabilidade**: N√≥s independentes test√°veis

## üîç Monitoramento

### Logs Estruturados
```
[VALIDATION] - Valida√ß√£o de entrada
[CACHE] - Opera√ß√µes de cache
[CONTEXT] - Prepara√ß√£o de contexto
[DATABASE] - Opera√ß√µes de banco
[QUERY] - Processamento de consultas
[REFINE] - Refinamento de respostas
[HISTORY] - Atualiza√ß√£o de hist√≥rico
```

### Estat√≠sticas
- Tempo de execu√ß√£o por n√≥
- Taxa de acerto do cache
- Estat√≠sticas de processamento CSV
- Valida√ß√£o de componentes

## üöÄ Roadmap de Expans√£o

### **üéØ Arquitetura Preparada para M√∫ltiplos Agentes**

A arquitetura atual est√° **perfeitamente preparada** para expans√£o com novos agentes especializados:

#### **üìÑ Agente PDF (Curto Prazo)**
```python
# Implementa√ß√£o planejada:
nodes/pdf_processing_node.py
agents/pdf_agent.py

# Funcionalidades:
- Extra√ß√£o de texto (PyPDF2, pdfplumber)
- OCR para documentos escaneados (Tesseract)
- An√°lise de estrutura de documentos
- Busca sem√¢ntica em conte√∫do
- Integra√ß√£o com LangGraph existente
```

#### **üóÑÔ∏è Agente MySQL (M√©dio Prazo)**
```python
# Implementa√ß√£o planejada:
nodes/mysql_node.py
agents/mysql_agent.py

# Funcionalidades:
- Conex√µes externas MySQL/PostgreSQL
- Pool de conex√µes otimizado
- Queries complexas com JOINs
- Transa√ß√µes e rollbacks
- M√∫ltiplas bases de dados
```

#### **üìä Agente de Gr√°ficos (M√©dio Prazo)**
```python
# Implementa√ß√£o planejada:
nodes/chart_generation_node.py
agents/chart_agent.py

# Funcionalidades:
- Matplotlib, Plotly, Seaborn
- Gr√°ficos baseados em consultas SQL
- An√°lise autom√°tica de dados
- Exporta√ß√£o em m√∫ltiplos formatos
- Dashboards interativos
```

#### **ü§ñ Agente de ML/Previs√µes (Longo Prazo)**
```python
# Implementa√ß√£o planejada:
nodes/prediction_node.py
agents/ml_agent.py

# Funcionalidades:
- Modelos de Machine Learning
- An√°lise de s√©ries temporais
- Previs√µes autom√°ticas
- Integra√ß√£o com scikit-learn
- AutoML capabilities
```

### **üîÑ Sistema de Detec√ß√£o Expandido**

```python
def detect_query_type(user_query: str) -> str:
    """Fun√ß√£o j√° preparada para expans√£o"""

    query_lower = user_query.lower().strip()

    # Detec√ß√£o atual
    if 'sql' in query_lower or 'tabela' in query_lower:
        return 'sql_query'

    # Expans√µes futuras (j√° estruturadas)
    elif 'pdf' in query_lower or 'documento' in query_lower:
        return 'pdf_processing'
    elif 'mysql' in query_lower or 'banco mysql' in query_lower:
        return 'mysql_query'
    elif 'gr√°fico' in query_lower or 'chart' in query_lower:
        return 'chart_generation'
    elif 'prever' in query_lower or 'previs√£o' in query_lower:
        return 'prediction'

    return 'sql_query'  # Default
```

### **üéõÔ∏è Roteamento Condicional Preparado**

```python
# No main_graph.py - Estrutura j√° preparada
def route_by_type(state: Dict[str, Any]) -> str:
    query_type = state.get("query_type", "sql_query")

    routing_map = {
        "sql_query": "sql_processing",
        "pdf_processing": "pdf_processing",      # FUTURO
        "mysql_query": "mysql_processing",       # FUTURO
        "chart_generation": "chart_generation",  # FUTURO
        "prediction": "prediction_processing"    # FUTURO
    }

    return routing_map.get(query_type, "sql_processing")
```

### **üìà Facilidade de Implementa√ß√£o**

**Por que √© f√°cil expandir:**
- ‚úÖ **Estrutura modular** - Cada agente = novo n√≥
- ‚úÖ **ObjectManager flex√≠vel** - Gerencia qualquer objeto
- ‚úÖ **Sistema de detec√ß√£o** - J√° preparado para novos tipos
- ‚úÖ **Configura√ß√µes centralizadas** - F√°cil adicionar APIs
- ‚úÖ **Interface din√¢mica** - Dropdown autom√°tico
- ‚úÖ **Async/await** - Performance mantida
- ‚úÖ **Logs estruturados** - Debugging facilitado

### **üéØ Pr√≥ximos Passos Recomendados**

1. **Agente PDF** - Implementa√ß√£o mais simples e √∫til
2. **Sistema de Templates** - Prompts especializados por agente
3. **M√©tricas avan√ßadas** - Performance por tipo de agente
4. **API REST** - Exposi√ß√£o de funcionalidades
5. **Agente MySQL** - Conex√µes externas
6. **Sistema de Pipelines** - Combina√ß√£o de agentes

---

**üèÜ Conclus√£o**: A arquitetura atual √© **excepcional** e est√° perfeitamente preparada para se tornar uma **plataforma completa de agentes especializados**. A expans√£o ser√° natural e incremental, mantendo a robustez e performance existentes.
